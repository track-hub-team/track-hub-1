{% extends "base_template.html" %}

{% block title %}Manage {{ community.name }}{% endblock %}

{% block content %}

    {# Mensajes flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Cabecera de la comunidad -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i data-feather="settings"></i> Manage Community
                    </h1>
                    <p class="text-muted mb-0">{{ community.name }}</p>
                </div>
                <div>
                    <a href="{{ url_for('community.view', slug=community.slug) }}"
                       class="btn btn-outline-secondary">
                        <i data-feather="eye"></i> View Community
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación de pestañas -->
    <ul class="nav nav-tabs mb-4" id="manageTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="requests-tab" data-bs-toggle="tab"
                    data-bs-target="#requests" type="button" role="tab">
                <i data-feather="inbox"></i>
                Pending Requests
                {% if requests %}
                    <span class="badge bg-primary rounded-pill ms-1">{{ requests|length }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                    data-bs-target="#settings" type="button" role="tab">
                <i data-feather="sliders"></i> Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="curators-tab" data-bs-toggle="tab"
                    data-bs-target="#curators" type="button" role="tab">
                <i data-feather="shield"></i> Curators
            </button>
        </li>
    </ul>

    <!-- Contenido de pestañas -->
    <div class="tab-content" id="manageTabsContent">

        <!-- Pestaña de solicitudes pendientes -->
        <div class="tab-pane fade show active" id="requests" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Dataset Submission Requests</h5>
                        </div>
                        <div class="card-body">
                            {% if requests %}
                                <div class="list-group list-group-flush">
                                    {% for request in requests %}
                                        <div class="list-group-item px-0 py-3" id="request-{{ request.id }}">
                                            <div class="row">
                                                <div class="col-12 col-lg-8">
                                                    <div class="d-flex align-items-start mb-2">
                                                        <div class="me-3">
                                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                                                 style="width: 40px; height: 40px;">
                                                                <span class="fw-bold">
                                                                    {{ request.requester.profile.name[0] if request.requester.profile else 'U' }}{{ request.requester.profile.surname[0] if request.requester.profile else 'U' }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-1">
                                                                {% if request.dataset %}
                                                                    <a href="{{ request.dataset.get_uvlhub_doi() }}"
                                                                       target="_blank"
                                                                       class="text-decoration-none">
                                                                        {{ request.dataset.ds_meta_data.title }}
                                                                        <i data-feather="external-link" style="width: 14px; height: 14px;"></i>
                                                                    </a>
                                                                {% else %}
                                                                    Dataset #{{ request.dataset_id }}
                                                                {% endif %}
                                                            </h6>
                                                            <p class="text-muted small mb-2">
                                                                Requested by <strong>{{ request.requester.profile.name if request.requester.profile else request.requester.email }} {{ request.requester.profile.surname if request.requester.profile else '' }}</strong>
                                                                ({{ request.requester.email }})
                                                                · {{ request.requested_at }}
                                                            </p>

                                                            {% if request.dataset %}
                                                                <p class="text-muted small mb-2">
                                                                    {{ request.dataset.ds_meta_data.description[:200] }}{% if request.dataset.ds_meta_data.description|length > 200 %}...{% endif %}
                                                                </p>
                                                                <div class="d-flex gap-3 small text-muted mb-2">
                                                                    <span>
                                                                        <i data-feather="file" style="width: 12px; height: 12px;"></i>
                                                                        {{ request.dataset.get_files_count() }} files
                                                                    </span>
                                                                    <span>
                                                                        <i data-feather="hard-drive" style="width: 12px; height: 12px;"></i>
                                                                        {{ request.dataset.get_file_total_size_for_human() }}
                                                                    </span>
                                                                </div>
                                                            {% endif %}

                                                            {% if request.message %}
                                                                <div class="alert alert-light border mt-2 mb-0 small">
                                                                    <strong>Message:</strong> {{ request.message }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-lg-4 text-lg-end">
                                                    <span class="badge bg-warning text-dark mb-2">{{ request.status|upper }}</span>
                                                    <div class="btn-group d-block mt-2" role="group">
                                                        <button type="button"
                                                                class="btn btn-sm btn-success me-2"
                                                                onclick="openApproveModal({{ request.id }}, '{{ community.slug }}', {{ request.dataset_id }}, '{{ request.dataset.ds_meta_data.title if request.dataset else 'Dataset #' ~ request.dataset_id }}')">
                                                            <i data-feather="check" style="width: 14px; height: 14px;"></i> Approve
                                                        </button>
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-danger"
                                                                onclick="openRejectModal({{ request.id }}, '{{ community.slug }}', {{ request.dataset_id }}, '{{ request.dataset.ds_meta_data.title if request.dataset else 'Dataset #' ~ request.dataset_id }}')">
                                                            <i data-feather="x" style="width: 14px; height: 14px;"></i> Reject
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i data-feather="check-circle" style="width: 48px; height: 48px;" class="text-muted mb-3"></i>
                                    <h5 class="text-muted">No pending requests</h5>
                                    <p class="text-muted">
                                        All dataset submissions have been reviewed. New requests will appear here.
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de configuración -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="row">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Community Settings</h5>
                        </div>
                        <div class="card-body">
                            <form action="{{ url_for('community.update_community', slug=community.slug) }}"
                                  method="POST"
                                  enctype="multipart/form-data"
                                  id="settingsForm">

                                <!-- Nombre de la comunidad -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Community Name</label>
                                    <input type="text" class="form-control" value="{{ community.name }}" disabled>
                                    <small class="form-text text-muted">
                                        <i data-feather="lock" style="width: 12px; height: 12px;"></i>
                                        The community name cannot be changed to maintain URL integrity
                                    </small>
                                </div>

                                <!-- Descripción -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description *</label>
                                    <textarea name="description"
                                              class="form-control"
                                              rows="5"
                                              required
                                              maxlength="2000"
                                              id="descriptionInput">{{ community.description }}</textarea>
                                    <div class="d-flex justify-content-between">
                                        <small class="form-text text-muted">Describe the purpose and focus of this community</small>
                                        <small class="text-muted" id="descriptionCounter">{{ community.description|length }}/2000</small>
                                    </div>
                                </div>

                                <!-- Logo -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Community Logo</label>
                                    <div class="mb-2">
                                        <img src="{{ community.get_logo_url() }}"
                                             alt="{{ community.name }}"
                                             class="rounded"
                                             style="width: 100px; height: 100px; object-fit: cover;"
                                             id="logoPreview">
                                    </div>
                                    <input type="file"
                                           class="form-control"
                                           name="logo"
                                           accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                                           id="logoInput">
                                    <small class="form-text text-muted">
                                        Accepted formats: JPG, PNG, GIF, WEBP. Max size: 2MB
                                    </small>
                                </div>

                                <!-- Botón de envío -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-feather="save"></i> Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Quick Info</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-6 small">Community ID</dt>
                                <dd class="col-6 small text-muted">{{ community.id }}</dd>

                                <dt class="col-6 small">Slug</dt>
                                <dd class="col-6 small text-muted">{{ community.slug }}</dd>

                                <dt class="col-6 small">Created</dt>
                                <dd class="col-6 small text-muted">{{ community.created_at }}</dd>

                                <dt class="col-6 small">Updated</dt>
                                <dd class="col-6 small text-muted">{{ community.updated_at }}</dd>

                                <dt class="col-6 small">Datasets</dt>
                                <dd class="col-6 small text-muted">{{ community.datasets_count }}</dd>

                                <dt class="col-6 small">Curators</dt>
                                <dd class="col-6 small text-muted">{{ community.curators|length }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de curadores -->
        <div class="tab-pane fade" id="curators" role="tabpanel">
            <div class="row">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Manage Curators</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                {% for curator in community.curators %}
                                    <div class="list-group-item px-0 py-3">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                                         style="width: 48px; height: 48px;">
                                                        <span class="fw-bold">{{ curator.user.profile.name[0] if curator.user.profile else 'U' }}{{ curator.user.profile.surname[0] if curator.user.profile else 'U' }}</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">{{ curator.user.profile.name if curator.user.profile else curator.user.email }} {{ curator.user.profile.surname if curator.user.profile else '' }}</h6>
                                                    <p class="text-muted small mb-0">{{ curator.user.email }}</p>
                                                    {% if curator.user_id == community.creator_id %}
                                                        <span class="badge bg-success mt-1">Creator</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div>
                                                {% if curator.user_id != community.creator_id %}
                                                    {% set curator_name = (curator.user.profile.name ~ ' ' ~ curator.user.profile.surname) if curator.user.profile and curator.user.profile.name else curator.user.email %}
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            onclick="removeCurator({{ curator.user_id }}, '{{ curator_name }}')">
                                                        <i data-feather="user-minus" style="width: 14px; height: 14px;"></i> Remove
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted small">Cannot remove creator</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="mt-4">
                                <button class="btn btn-primary" onclick="openAddCuratorModal()">
                                    <i data-feather="user-plus"></i> Add Curator
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h5 class="card-title mb-0">About Curators</h5>
                        </div>
                        <div class="card-body">
                            <p class="small">
                                Curators are responsible for reviewing and approving dataset submissions to the community.
                            </p>
                            <h6 class="fw-bold mt-3">Curator Responsibilities:</h6>
                            <ul class="small">
                                <li>Review dataset submissions</li>
                                <li>Approve or reject requests</li>
                                <li>Ensure quality and relevance</li>
                                <li>Maintain community guidelines</li>
                            </ul>
                            <h6 class="fw-bold mt-3">Permissions:</h6>
                            <ul class="small">
                                <li>View all pending requests</li>
                                <li>Approve/reject datasets</li>
                                <li>Manage community settings</li>
                                <li>Add/remove other curators</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón de regreso -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('community.view', slug=community.slug) }}" class="btn btn-outline-secondary">
                <i data-feather="arrow-left"></i> Back to Community
            </a>
        </div>
    </div>

    <!-- Modal de aprobación -->
    <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveModalLabel">
                        <i data-feather="check-circle"></i> Approve Dataset Request
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">You are about to approve the dataset: <strong id="approveDatasetTitle"></strong></p>

                    <div class="alert alert-success">
                        <i data-feather="info" style="width: 16px; height: 16px;"></i>
                        <strong>What happens next:</strong>
                        <ul class="mb-0 mt-2">
                            <li>The dataset will be added to this community</li>
                            <li>The requester will be notified of the approval</li>
                            <li>The dataset will be visible to all community members</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-success" id="confirmApproveBtn">
                        <i data-feather="check"></i> Confirm Approval
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de añadir curador -->
    <div class="modal fade" id="addCuratorModal" tabindex="-1" aria-labelledby="addCuratorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCuratorModalLabel">
                        <i data-feather="user-plus"></i> Add Curator
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Search and select a user to add as curator to this community.</p>

                    <!-- Entrada de búsqueda -->
                    <div class="mb-3">
                        <label for="curatorSearch" class="form-label fw-bold">Search user</label>
                        <input type="text" class="form-control" id="curatorSearch"
                               placeholder="Search by name or email...">
                        <small class="form-text text-muted">
                            Type at least 3 characters to search
                        </small>
                    </div>

                    <!-- Resultados de búsqueda -->
                    <div id="curatorSearchResults" style="display: none;">
                        <label class="form-label fw-bold">Select user:</label>
                        <div id="curatorResultsList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Mensaje de no resultados -->
                    <div id="curatorNoResults" style="display: none;">
                        <div class="alert alert-info small">
                            <i data-feather="info" style="width: 16px; height: 16px;"></i>
                            No users found. Try a different search term.
                        </div>
                    </div>

                    <!-- Estado de carga -->
                    <div id="curatorSearchLoading" style="display: none;">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2 text-muted">Searching...</span>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <i data-feather="info" style="width: 16px; height: 16px;"></i>
                        <strong>About curators:</strong> Curators can review dataset submissions, approve or reject requests, and manage community settings.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de rechazo -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">
                        <i data-feather="alert-triangle"></i> Reject Dataset Request
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">You are about to reject the dataset: <strong id="rejectDatasetTitle"></strong></p>

                    <div class="mb-3">
                        <label for="rejectReason" class="form-label fw-bold">
                            Reason for rejection <span class="text-muted">(Optional)</span>
                        </label>
                        <textarea class="form-control" id="rejectReason" rows="4"
                                  placeholder="Explain why this dataset doesn't fit the community..."></textarea>
                        <small class="form-text text-muted">
                            <span id="rejectReasonCharCount">0</span>/500 characters · This message will be sent to the requester
                        </small>
                    </div>

                    <div class="alert alert-warning small">
                        <i data-feather="info" style="width: 16px; height: 16px;"></i>
                        <strong>Note:</strong> This action cannot be undone. The requester will be notified of the rejection.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                        <i data-feather="x-circle"></i> Confirm Rejection
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    // Inicializar iconos de Feather
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Re-inicializar iconos cuando cambian las pestañas y persistir la pestaña activa
    const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function(e) {
            // Re-inicializar iconos de Feather
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            // Guardar pestaña activa en sessionStorage
            const activeTab = e.target.getAttribute('data-bs-target');
            sessionStorage.setItem('communityManageActiveTab', activeTab);
        });
    });

    // Restaurar pestaña activa al cargar la página
    const savedTab = sessionStorage.getItem('communityManageActiveTab');
    if (savedTab) {
        const tabButton = document.querySelector(`button[data-bs-target="${savedTab}"]`);
        if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
        }
    }

    // Contador de caracteres para la descripción
    const descriptionInput = document.getElementById('descriptionInput');
    const descriptionCounter = document.getElementById('descriptionCounter');

    if (descriptionInput && descriptionCounter) {
        descriptionInput.addEventListener('input', function() {
            const length = this.value.length;
            descriptionCounter.textContent = `${length}/2000`;
        });
    }

    // Formulario de configuración: Vista previa del logo
    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');

    if (logoInput && logoPreview) {
        logoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validar tamaño del archivo (máximo 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('File size must be less than 2MB');
                    this.value = '';
                    return;
                }

                // Validar tipo de archivo
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPG, PNG, GIF, or WEBP)');
                    this.value = '';
                    return;
                }

                // Mostrar vista previa
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Variables para modales de aprobación y rechazo
    let approveModalData = {
        requestId: null,
        communitySlug: null,
        datasetId: null
    };

    let rejectModalData = {
        requestId: null,
        communitySlug: null,
        datasetId: null
    };

    // Contador de caracteres para el motivo de rechazo
    const rejectReasonField = document.getElementById('rejectReason');
    const rejectReasonCharCount = document.getElementById('rejectReasonCharCount');

    if (rejectReasonField && rejectReasonCharCount) {
        rejectReasonField.addEventListener('input', function() {
            const length = this.value.length;
            rejectReasonCharCount.textContent = length;
            // Limitar a 500 caracteres
            if (length > 500) {
                this.value = this.value.substring(0, 500);
                rejectReasonCharCount.textContent = 500;
            }
        });
    }

    // Re-inicializar iconos cuando se muestran los modales
    const approveModal = document.getElementById('approveModal');
    const rejectModal = document.getElementById('rejectModal');
    const addCuratorModal = document.getElementById('addCuratorModal');

    if (approveModal) {
        approveModal.addEventListener('shown.bs.modal', function() {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
    }

    if (rejectModal) {
        rejectModal.addEventListener('shown.bs.modal', function() {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });

        // Limpiar formulario cuando se oculta el modal
        rejectModal.addEventListener('hidden.bs.modal', function() {
            rejectReasonField.value = '';
            rejectReasonCharCount.textContent = '0';
        });
    }

    if (addCuratorModal) {
        addCuratorModal.addEventListener('shown.bs.modal', function() {
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            // Enfocar en el campo de búsqueda
            document.getElementById('curatorSearch').focus();
        });

        // Limpiar búsqueda cuando se oculta el modal
        addCuratorModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('curatorSearch').value = '';
            document.getElementById('curatorSearchResults').style.display = 'none';
            document.getElementById('curatorNoResults').style.display = 'none';
            document.getElementById('curatorResultsList').innerHTML = '';
        });
    }

    // Función para abrir el modal de aprobación
    function openApproveModal(requestId, communitySlug, datasetId, datasetTitle) {
        approveModalData = { requestId, communitySlug, datasetId };
        document.getElementById('approveDatasetTitle').textContent = datasetTitle;
        const modal = new bootstrap.Modal(document.getElementById('approveModal'));
        modal.show();
    }

    // Función para abrir el modal de rechazo
    function openRejectModal(requestId, communitySlug, datasetId, datasetTitle) {
        rejectModalData = { requestId, communitySlug, datasetId };
        document.getElementById('rejectDatasetTitle').textContent = datasetTitle;
        const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
        modal.show();
    }

    // Manejar confirmación de aprobación
    document.getElementById('confirmApproveBtn').addEventListener('click', function() {
        const { requestId, communitySlug, datasetId } = approveModalData;

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('approveModal'));
        modal.hide();

        // Llamar al manejador de aprobación
        handleRequest(requestId, communitySlug, datasetId, 'approve');
    });

    // Manejar confirmación de rechazo
    document.getElementById('confirmRejectBtn').addEventListener('click', function() {
        const reason = rejectReasonField.value.trim();
        const { requestId, communitySlug, datasetId } = rejectModalData;

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
        modal.hide();

        // Llamar al manejador de rechazo con motivo
        handleRequest(requestId, communitySlug, datasetId, 'reject', reason);
    });

    // Función para abrir el modal de añadir curador
    function openAddCuratorModal() {
        const modal = new bootstrap.Modal(document.getElementById('addCuratorModal'));
        modal.show();
    }

    // Buscar usuarios
    let searchTimeout;
    const curatorSearchInput = document.getElementById('curatorSearch');
    const curatorResultsList = document.getElementById('curatorResultsList');
    const curatorSearchResults = document.getElementById('curatorSearchResults');
    const curatorNoResults = document.getElementById('curatorNoResults');
    const curatorSearchLoading = document.getElementById('curatorSearchLoading');

    if (curatorSearchInput) {
        curatorSearchInput.addEventListener('input', function() {
            const query = this.value.trim();

            // Limpiar timeout previo
            clearTimeout(searchTimeout);

            // Ocultar todos los estados
            curatorSearchResults.style.display = 'none';
            curatorNoResults.style.display = 'none';
            curatorSearchLoading.style.display = 'none';

            if (query.length < 2) {
                return;
            }

            // Mostrar carga
            curatorSearchLoading.style.display = 'block';

            // Búsqueda con debounce
            searchTimeout = setTimeout(() => {
                // Llamar a la API para buscar usuarios, excluyendo curadores existentes
                fetch(`/community/api/search-users?q=${encodeURIComponent(query)}&community_id={{ community.id }}`)
                    .then(response => response.json())
                    .then(data => {
                        // Ocultar carga
                        curatorSearchLoading.style.display = 'none';

                        if (data.users.length === 0) {
                            curatorNoResults.style.display = 'block';
                        } else {
                            // Mostrar resultados
                            curatorResultsList.innerHTML = '';
                            data.users.forEach(user => {
                                const item = document.createElement('a');
                                item.href = '#';
                                item.className = 'list-group-item list-group-item-action';
                                const initials = (user.name && user.surname)
                                    ? `${user.name[0]}${user.surname[0]}`
                                    : (user.email ? user.email.substring(0, 2).toUpperCase() : 'U');
                                const displayName = (user.name && user.surname)
                                    ? `${user.name} ${user.surname}`
                                    : user.email;
                                item.innerHTML = `
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <span class="fw-bold">${initials}</span>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">${displayName}</div>
                                            <small class="text-muted">${user.email}</small>
                                        </div>
                                        <div>
                                            <i data-feather="plus-circle" style="width: 20px; height: 20px;"></i>
                                        </div>
                                    </div>
                                `;
                                item.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    addCurator(user.id, user.name, user.surname, user.email);
                                });
                                curatorResultsList.appendChild(item);
                            });

                            curatorSearchResults.style.display = 'block';

                            // Re-inicializar iconos
                            if (typeof feather !== 'undefined') {
                                feather.replace();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error searching users:', error);
                        curatorSearchLoading.style.display = 'none';
                        curatorNoResults.style.display = 'block';
                    });
            }, 500);
        });
    }

    // Función para añadir curador
    function addCurator(userId, name, surname, email) {
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCuratorModal'));
        modal.hide();

        const url = `/community/{{ community.slug }}/add-curator`;

        // Preparar datos del formulario
        const formData = new FormData();
        formData.append('user_id', userId);

        // Realizar solicitud POST del formulario
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                window.location.reload();
            } else {
                console.error('Error adding curator');
                alert('Error adding curator. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding curator. Please try again.');
        });
    }

    // Función para eliminar curador
    function removeCurator(curatorId, curatorName) {
        if (!confirm(`Are you sure you want to remove ${curatorName} as curator?`)) {
            return;
        }

        const url = `/community/{{ community.slug }}/remove-curator`;

        // Preparar datos del formulario
        const formData = new FormData();
        formData.append('user_id', curatorId);

        // Realizar solicitud POST del formulario
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                window.location.reload();
            } else {
                console.error('Error removing curator');
                alert('Error removing curator. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing curator. Please try again.');
        });
    }

    // Función para manejar la aprobación/rechazo de solicitudes
    function handleRequest(requestId, communitySlug, datasetId, action, reason = '') {
        const actionText = action === 'approve' ? 'approve' : 'reject';
        const url = `/community/${communitySlug}/request/${requestId}/${action}`;

        // Mostrar estado de carga
        const requestElement = document.getElementById(`request-${requestId}`);
        if (requestElement) {
            requestElement.style.opacity = '0.5';
            requestElement.style.pointerEvents = 'none';
        }

        // Preparar datos del formulario
        const formData = new FormData();
        if (action === 'reject' && reason) {
            formData.append('comment', reason);
        }

        // Realizar solicitud POST del formulario
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected || response.ok) {
                alert(`Dataset ${actionText}ed successfully!`);

                // Eliminar la solicitud de la lista
                if (requestElement) {
                    requestElement.remove();
                }

                const badge = document.querySelector('#requests-tab .badge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent);
                    const newCount = currentCount - 1;
                    if (newCount > 0) {
                        badge.textContent = newCount;
                    } else {
                        badge.remove();
                        // Mostrar estado vacío
                        const listGroup = document.querySelector('#requests .list-group');
                        if (listGroup && listGroup.children.length === 0) {
                            listGroup.innerHTML = `
                                <div class="text-center py-5">
                                    <i data-feather="check-circle" style="width: 48px; height: 48px;" class="text-muted mb-3"></i>
                                    <h5 class="text-muted">No pending requests</h5>
                                    <p class="text-muted">All dataset submissions have been reviewed.</p>
                                </div>
                            `;
                            if (typeof feather !== 'undefined') {
                                feather.replace();
                            }
                        }
                    }
                }
            } else {
                alert(`Error: Failed to ${action} request`);
                // Restaurar estado del elemento
                if (requestElement) {
                    requestElement.style.opacity = '1';
                    requestElement.style.pointerEvents = 'auto';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            // Restaurar estado del elemento
            if (requestElement) {
                requestElement.style.opacity = '1';
                requestElement.style.pointerEvents = 'auto';
            }
        });
    }
</script>
{% endblock %}
