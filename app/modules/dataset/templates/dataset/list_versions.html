{% extends "base_template.html" %}

{% block title %}Version History{% endblock %}

{% block content %}

<div class="row mb-3">
    <div class="col-12">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Explore</a></li>

                {% if dataset.ds_meta_data.dataset_doi %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dataset.subdomain_index', doi=dataset.ds_meta_data.dataset_doi) }}">
                            {{ dataset.ds_meta_data.title }}
                        </a>
                    </li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dataset.get_unsynchronized_dataset', dataset_id=dataset.id) }}">
                            {{ dataset.ds_meta_data.title }}
                        </a>
                    </li>
                {% endif %}

                <li class="breadcrumb-item active">Versions</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>
                    <i data-feather="clock"></i>
                    Version History
                </h2>

                <!-- Bot√≥n crear versi√≥n (solo propietario y NO sincronizado) -->
                {% if current_user.is_authenticated and current_user.id == dataset.user_id and not dataset.ds_meta_data.dataset_doi %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createVersionModal">
                    <i data-feather="plus"></i> Create New Version
                </button>
                {% endif %}
            </div>

            <!-- DOI Information Section -->
            {% if dataset.ds_meta_data.dataset_doi %}
            <div class="card-body border-bottom bg-light">
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h6 class="text-muted mb-2">
                            <i data-feather="bookmark" style="width: 16px; height: 16px;"></i>
                            Conceptual DOI (Always points to latest published version)
                        </h6>
                        <div class="input-group">
                            <input type="text" class="form-control" id="conceptual_doi"
                                   value="{{ dataset.ds_meta_data.dataset_doi.rsplit('.v', 1)[0] if '.v' in dataset.ds_meta_data.dataset_doi else dataset.ds_meta_data.dataset_doi }}"
                                   readonly>
                            <button class="btn btn-outline-secondary" type="button"
                                    onclick="copyText('conceptual_doi')">
                                <i data-feather="copy" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">
                            <i data-feather="git-branch" style="width: 16px; height: 16px;"></i>
                            Version Types
                        </h6>
                        <p class="mb-0 small text-muted">
                            <strong>Major versions</strong> (with DOI) are published to Zenodo and include file changes.
                            <strong>Minor/Patch versions</strong> (no DOI) track metadata improvements locally.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card-body">

                <!-- ‚úÖ Obtener la √∫ltima versi√≥n (m√°s reciente) -->
                {% set latest_version = versions[0] if versions else None %}

                {% for version in versions %}
                <div class="card mb-3 {% if loop.first %}border-primary{% endif %}">
                    <div class="card-header {% if loop.first %}bg-primary text-white{% endif %}">
                        <div class="row align-items-center">
                            <!-- Columna izquierda: Informaci√≥n de la versi√≥n -->
                            <div class="col-md-8 col-12 mb-2 mb-md-0">
                                <h4 class="mb-1">
                                    <!-- Badge de versi√≥n -->
                                    <span class="badge {% if version.id == latest_version.id %}bg-primary{% else %}bg-dark{% endif %} fs-5 me-2 px-3 py-2">
                                        v{{ version.version_number }}
                                    </span>
                                    {{ version.title }}

                                    <!-- Badge "Current" solo en la √∫ltima -->
                                    {% if version.id == latest_version.id %}
                                    <span class="badge bg-success fs-6 px-3 py-2">Current</span>
                                    {% endif %}
                                </h4>
                                <p class="mb-0 {% if loop.first %}text-white-50{% else %}text-muted{% endif %}">
                                    <small>
                                        <i data-feather="user" style="width: 14px; height: 14px;"></i>
                                        {{ version.created_by.profile.name }}
                                        ‚Ä¢
                                        <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                                        {{ version.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                    </small>
                                </p>
                            </div>

                            <!-- Columna derecha: Botones de acci√≥n -->
                            <div class="col-md-4 col-12 text-md-end">
                        {% if not loop.last %}
                            {% set previous_version = versions[loop.index] %}
                            <a href="{{ url_for('dataset.compare_versions',
                                                version1_id=version.id,
                                                version2_id=previous_version.id) }}"
                            class="btn btn-light btn-sm">
                                Compare with previous
                            </a>

                            <a href="{{ url_for('dataset.view_version',
                                                dataset_id=dataset.id,
                                                version_id=version.id) }}"
                            class="btn btn-outline-light btn-sm ms-2">
                                <i data-feather="eye"></i> View version
                            </a>

                        {% else %}
                            <span class="badge bg-light text-dark fs-6 py-2 px-3">
                                <i data-feather="award"></i> First version
                            </span>

                            <a href="{{ url_for('dataset.view_version',
                                                dataset_id=dataset.id,
                                                version_id=version.id) }}"
                            class="btn btn-outline-light btn-sm ms-2">
                                <i data-feather="eye"></i> View version
                            </a>
                        {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- Version-Specific DOI -->
                        {% if version.version_doi %}
                        <div class="mb-3 p-2 bg-success bg-opacity-10 rounded border border-success">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block mb-1">
                                        <i data-feather="link" style="width: 14px; height: 14px;"></i>
                                        <strong>üìå Major version (X.0.0)</strong> - Published to Zenodo with DOI
                                    </small>
                                    <input type="text" class="form-control form-control-sm"
                                           id="version_doi_{{ version.id }}"
                                           value="{{ version.version_doi }}" readonly>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary ms-2"
                                        type="button"
                                        onclick="navigator.clipboard.writeText('{{ version.version_doi }}'); this.innerHTML='<i data-feather=\'check\'></i> Copied'; setTimeout(() => this.innerHTML='<i data-feather=\'copy\'></i>', 2000); feather.replace();">
                                    <i data-feather="copy"></i>
                                </button>
                            </div>
                        </div>
                        {% elif dataset.ds_meta_data.dataset_doi and version.version_number.split('.')[0]|int >= 1 %}
                        <div class="mb-3 p-2 bg-info bg-opacity-10 rounded border border-info">
                            <small class="text-muted">
                                <i data-feather="edit-3" style="width: 14px; height: 14px;"></i>
                                {% if version.version_number.split('.')[1]|int > 0 %}
                                <strong>üìù Minor version (X.Y.0)</strong> - Metadata improvements (no DOI)
                                {% else %}
                                <strong>üîß Patch version (X.Y.Z)</strong> - Metadata corrections (no DOI)
                                {% endif %}
                            </small>
                        </div>
                        {% else %}
                        <div class="mb-3 p-2 bg-warning bg-opacity-10 rounded border border-warning">
                            <small class="text-muted">
                                <i data-feather="info" style="width: 14px; height: 14px;"></i>
                                <strong>üì¶ Local version</strong> - Created before publication to Zenodo
                            </small>
                        </div>
                        {% endif %}

                        <!-- Changelog -->
                        <div class="mb-3">
                            <h6><strong>Changes:</strong></h6>
                            <pre class="bg-light p-2 rounded">{{ version.changelog }}</pre>
                        </div>

                        <!-- ‚úÖ Estad√≠sticas espec√≠ficas por tipo -->
                        {% if dataset.dataset_kind == 'gpx' %}
                        <div class="row">
                            <div class="col-12">
                                <h6><i data-feather="activity"></i> <strong>GPX Statistics:</strong></h6>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>km</strong></h6>
                                        <p class="mb-0"><small>Distance</small></p>
                                        <h5 class="mb-0">{{ "%.1f"|format(version.total_distance / 1000) if version.total_distance else '-' }}</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ "%.1f"|format(version.total_elevation_gain) if version.total_elevation_gain else '-' }} m</strong></h6>
                                        <p class="mb-0"><small>Elevation Gain</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.track_count or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Tracks</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_points or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Points</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% elif dataset.dataset_kind == 'uvl' %}
                        <div class="row">
                            <div class="col-12">
                                <h6><strong>UVL Statistics:</strong></h6>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.model_count if version.model_count is not none else '-' }}</strong></h6>
                                        <p class="mb-0"><small>Models</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_features if version.total_features is not none else '-' }}</strong></h6>
                                        <p class="mb-0"><small>Features</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_constraints if version.total_constraints is not none else '-' }}</strong></h6>
                                        <p class="mb-0"><small>Constraints</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Files -->
                        <div class="mt-3">
                            <h6><i data-feather="file"></i> <strong>Files ({{ version.files_snapshot|length }}):</strong></h6>
                            <ul class="list-group list-group-flush">
                                {% for filename, info in version.files_snapshot.items() %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <i data-feather="file"></i>
                                        {{ filename }}
                                    </span>
                                    <span class="text-muted">
                                        <small>{{ (info.size / 1024)|round(2) }} KB</small>
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if not versions %}
                <div class="alert alert-info">
                    <i data-feather="info"></i>
                    No versions found for this dataset.
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!-- Modal crear versi√≥n -->
{% if current_user.is_authenticated and current_user.id == dataset.user_id and not dataset.ds_meta_data.dataset_doi %}
<div class="modal fade" id="createVersionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('dataset.create_version', dataset_id=dataset.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i data-feather="git-branch"></i> Create New Version
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small>
                            <strong>Local version:</strong> A snapshot of the current state will be saved.
                            When you publish to Zenodo, it will start with v1.0.0 regardless of your local version numbers.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Version Type</label>
                        <select class="form-select" name="bump_type" id="bump_type">
                            <option value="patch" selected>üîß Patch (X.Y.Z+1) - Bug fixes, small changes</option>
                            <option value="minor">‚ú® Minor (X.Y+1.0) - New features, compatible changes</option>
                            <option value="major">üöÄ Major (X+1.0.0) - Breaking changes, major updates</option>
                        </select>
                        <small class="text-muted" id="versionPreview">
                            Current version: <strong>v{{ latest_version.version_number if latest_version else '0.0.0' }}</strong>
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="changelog" class="form-label">Changelog <span class="text-danger">*</span></label>
                        <textarea
                            class="form-control"
                            id="changelog"
                            name="changelog"
                            rows="4"
                            required
                            placeholder="Describe the changes made in this version...&#10;Example:&#10;- Added new feature models&#10;- Updated dataset metadata&#10;- Fixed file naming"
                        ></textarea>
                        <small class="text-muted">Describe what changed in this version</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i> Create Version
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- ‚úÖ Estilos CSS para mejorar visibilidad -->
<style>
    /* Bot√≥n comparar - versi√≥n actual (amarillo brillante) */
    .bg-primary .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .bg-primary .btn-warning:hover {
        background-color: #ffb300;
        border-color: #ffb300;
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    /* Bot√≥n comparar - versiones anteriores (azul) */
    .btn-primary {
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(13,110,253,0.3);
    }

    /* Badge "First version" m√°s grande */
    .badge.fs-6 {
        font-size: 0.95rem !important;
    }

    /* Asegurar que los botones sean visibles */
    .card-header .btn {
        white-space: nowrap;
        min-width: auto;
    }

    /* Responsive: ajustar en m√≥vil */
    @media (max-width: 992px) {
        .btn-sm {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }

        .card-header .row {
            gap: 0.5rem;
        }
    }

    /* Mejorar contraste del card con fondo azul */
    .bg-primary {
        background-color: #0d6efd !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar iconos Feather
        feather.replace();

        // Preview de la nueva versi√≥n al cambiar tipo
        const bumpTypeSelect = document.getElementById('bump_type');
        if (bumpTypeSelect) {
            bumpTypeSelect.addEventListener('change', function() {
                const currentVersion = '{{ latest_version.version_number if latest_version else "0.0.0" }}';
                const [major, minor, patch] = currentVersion.split('.').map(Number);

                let newVersion;
                switch(this.value) {
                    case 'major':
                        newVersion = `${major + 1}.0.0`;
                        break;
                    case 'minor':
                        newVersion = `${major}.${minor + 1}.0`;
                        break;
                    case 'patch':
                    default:
                        newVersion = `${major}.${minor}.${patch + 1}`;
                        break;
                }

                // Actualizar el preview
                const preview = document.getElementById('versionPreview');
                preview.innerHTML = `Current version: <strong>v${currentVersion}</strong> ‚Üí New version will be: <strong class="text-success">v${newVersion}</strong>`;
            });
        }
    });
</script>

{% endblock %}
